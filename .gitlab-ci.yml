###############################################################################
# Autogenerated GitLab CI
# https://gitlab.com/brandlight/wordpress/wp-ci-pattern
# plugin-gitlab-ci.yml
###############################################################################
# Template for GitLab CI configuration for Brandlight WordPress Themes/Plugins.
# Plugins version
# (Revision 2.0)
# The standard stages for a CI/CD pipeline

stages:
  - build
  - test
  - deploy_cms
  - deploy_prod
  - deploy_dev

# The Docker image we use that contains our custom CI scripts
image: registry.gitlab.com/agentdesign/sysadmin/docker/docker-agentdesign-wordpress-ci

# Copy our private SSH key and known hosts keys into place for SFTP deployments
before_script:
  - vault write -field=token auth/approle/login role_id=$VAULT_ROLE_ID secret_id=$VAULT_SECRET_ID >~/.vault-token
  - vault kv get -field=authjson cisecrets/cloudronbot | base64 -d >~/.cloudron.json
  - npm install -g cloudron
  - depdir=/app/data/public/wp-content/plugins
  - function cmkdir {  cloudron exec --app $1 -- bash -c "mkdir -p /app/data/ci/$CI_PROJECT_NAME; "; }
  - function cupload { cloudron push --app $1 wpcd-artefacts /app/data/ci/$CI_PROJECT_NAME; }
  - function cextract { cloudron exec --app $1 -- bash -c "rm -rf $depdir/$CI_PROJECT_NAME && unzip /app/data/ci/$CI_PROJECT_NAME/wpcd-artefacts/$CI_PROJECT_NAME.zip -d $depdir"; }
  - function cpostaction { cloudron exec --app $1 -- bash -c "rm -rf /app/data/public/wp-content/cache/supercache; rm -rf /app/data/public/wp-content/uploads/novembit-i18n/cache"; }
  - function cpush { cmkdir $1 && cupload $1 && cextract $1 && cpostaction $1; }

#########
# BUILD #
#########

# Build all branches using the 'build-wp-plugin' script to obtain a ZIP file
build:
  stage: build
  script:
    - build-wp-plugin -v
  artifacts:
    paths:
    - wpcd-artefacts/*.zip

########
# TEST #
########

# Remove leading dot to enable test stage if/when there are plugin unit tests
# (in most cases, plugins do not have test suites)
.test:
  stage: test
  script:
    - test-wp-plugin -v

test:
  stage: test
  script:
    - for file in $(find . -name "*.php"); do php -l $file; done

##########
# DEPLOY #
##########

# CMS
deploy:cloudron:cms:prod:
  stage: deploy_cms
  only:
    - develop
#    - master
  script:
    - cpush "cms.agentdesign.co.uk"

deploy:cloudron:cms:dev:
  stage: deploy_cms
  only:
    - develop
#    - master
  script:
    - cpush "devcms.brandlight.org"
########
# Prod #
########

#### For 'master' branch builds, store the latest copy in our Wasabi archive for subsequently run site builds.
deploy:wasabi:
  stage: deploy_prod
  only:
    - master
  environment:
    name: wasabi
    url: https://s3.eu-central-1.wasabisys.com/wordpress-plugins/production/${CI_PROJECT_NAME}.zip
  variables:
    WPCD_PLATFORM: "s3"
  script:
    - deploy-wp-plugin -v

deploy:cloudron:production:brandlight:
  stage: deploy_prod
  only:
    - master
  when: manual
  script:
    - cpush "brandlight.org"

deploy:cloudron:production:swanson:
  stage: deploy_prod
  only:
    - master
  when: manual
  script:
    - cpush "swanson.healthshop.co.uk"

deploy:cloudron:production:healthshop:
  stage: deploy_prod
  only:
    - master
  when: manual
  script:
    - cpush "healthshop.net"

#######
# Dev #
#######

deploy:cloudron:dev:masterclone:
  stage: deploy_dev
  only:
    - develop
#    - master
  script:
    - cpush "master-clone.brandlight.org"

deploy:cloudron:dev:jarrow:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.jarrow.co.uk

deploy:cloudron:dev:doctorsbest:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.doctorsbest.co.uk

deploy:cloudron:dev:drmercola:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.drmercola.uk

deploy:cloudron:dev:fairhavenhealth:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.fairhavenhealth.co.uk

deploy:cloudron:dev:garden-of-life:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.garden-of-life.co.uk

deploy:cloudron:dev:naturalfactors:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.naturalfactors.co.uk


deploy:cloudron:dev:planetaryherbals:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.planetaryherbals.co.uk


deploy:cloudron:dev:sourcenaturals:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.sourcenaturals.co.uk


deploy:cloudron:dev:mychelle:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush mychelle.brandlight.org

deploy:cloudron:dev:agentdesign:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.agentdesign.co.uk

deploy:cloudron:dev:authenticproduce:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.authenticproduce.com

deploy:cloudron:dev:swanson:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.swanson.healthshop.co.uk

deploy:cloudron:dev:healthshop:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush dev.healthshop.net

deploy:cloudron:demo:brandlight:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush demo.brandlight.org

deploy:cloudron:new:brandlight:
  stage: deploy_dev
  when: manual
  only:
    - develop
    - master
  script:
    - cpush new.brandlight.org
